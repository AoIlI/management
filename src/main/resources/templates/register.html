<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>注册</title>
    <link rel="stylesheet" href="/css/login.css">
    <style>
        .error-text {
            color: red;
            font-size: 12px;
            margin-top: 4px;
        }
    </style>
</head>
<body>

<div class="login-container">
    <div class="login-box">
        <h2 class="title">注册账号</h2>

        <form id="registerForm">

            <!-- 用户名 -->
            <div class="input-group">
                <input type="text" name="username" id="username" placeholder="请输入用户名" required>
                <div class="error-text" id="usernameError"></div>
            </div>

            <!-- 手机号 -->
            <div class="input-group">
                <input type="text" name="phone" id="phone" placeholder="请输入手机号" required>
                <div class="error-text" id="phoneError"></div>
            </div>

            <!-- 密码 -->
            <div class="input-group password-group">
                <input type="password" name="password" id="password" placeholder="请输入密码" required>
            </div>

            <div style="margin-top: 8px; display: flex; justify-content: space-between; font-size: 14px;">
                <a href="javascript:void(0);" onclick="showAdminPhone()" style="color:#409EFF; text-decoration:none;">
                    联系管理员
                </a>
                <a href="/login" style="color:#409EFF; text-decoration:none;">返回登录</a>
            </div>

            <button type="submit" class="login-btn" id="registerBtn">注册</button>
        </form>
    </div>
</div>

<script>
    const usernameInput = document.getElementById("username");
    const phoneInput = document.getElementById("phone");
    const passwordInput = document.getElementById("password");
    const usernameError = document.getElementById("usernameError");
    const phoneError = document.getElementById("phoneError");
    const registerBtn = document.getElementById("registerBtn");

    let usernameOk = false;
    let phoneOk = false;

    function updateButtonState() {
        registerBtn.disabled = !(usernameOk && phoneOk);
    }

    usernameInput.oninput = () => { usernameError.textContent = ""; usernameOk = false; updateButtonState(); };
    phoneInput.oninput = () => { phoneError.textContent = ""; phoneOk = false; updateButtonState(); };

    usernameInput.onblur = () => {
        const username = usernameInput.value.trim();
        if(!username) return;
        fetch("/api/register/check-username?username=" + encodeURIComponent(username))
            .then(res => res.json())
            .then(exists => {
                if(exists) {
                    usernameError.textContent = "用户名已存在";
                    usernameOk = false;
                } else {
                    usernameError.textContent = "";
                    usernameOk = true;
                }
                updateButtonState();
            });
    };

    phoneInput.onblur = () => {
        const phone = phoneInput.value.trim();
        if(!phone) return;
        const phonePattern = /^1\d{10}$/;
        if(!phonePattern.test(phone)) {
            phoneError.textContent = "请输入正确的电话号码";
            phoneOk = false;
            updateButtonState();
            return;
        }
        fetch("/api/register/check-phone?phone=" + encodeURIComponent(phone))
            .then(res => res.json())
            .then(exists => {
                if(exists) {
                    phoneError.textContent = "该电话号码已被注册，请联系管理员或找回";
                    phoneOk = false;
                } else {
                    phoneError.textContent = "";
                    phoneOk = true;
                }
                updateButtonState();
            });
    };

    document.getElementById("registerForm").addEventListener("submit", function(e) {
        e.preventDefault(); // 阻止默认提交
        if(!(usernameOk && phoneOk)) return;

        const formData = new URLSearchParams();
        formData.append("username", usernameInput.value.trim());
        formData.append("phone", phoneInput.value.trim());
        formData.append("password", passwordInput.value);

        fetch("/register", {
            method: "POST",
            body: formData
        })
            .then(res => {
                if(res.redirected) {
                    // 成功重定向 → 弹框提示
                    alert("注册成功，请返回登录");
                    window.location.href = res.url; // 跳转登录页
                } else {
                    return res.text(); // 错误返回
                }
            })
            .catch(err => {
                alert("注册失败，请重试");
                console.error(err);
            });
    });

    function showAdminPhone() {
        alert("管理员电话：666666666");
    }
</script>

</body>
</html>
